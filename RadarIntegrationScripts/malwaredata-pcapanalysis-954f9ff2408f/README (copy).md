# README #

This project generates bro logs after analysis of packet captures


### Copy the raw data to the backup from the GW2 ###
* In the 192.168.1.139 system in /media/MalwareDisk/MasterRawData/Network run
- scp -r jugaad@202.141.30.50:/home/jugaad//NetworkData/GW_Mar10_2021 .

* Copy the contents to the server as well as for processing
/media/MalwareDisk/MasterRawData/Network/network_copybackup.sh
  
scp -r jugaad@202.141.30.50:/home/jugaad/NetworkData/GW1_Mar11/enp1s0/* .
scp -r jugaad@202.141.30.50:/home/jugaad/NetworkData/GW1_Mar11/enp2s0/* .
  scp -r jugaad@202.141.30.50:/home/jugaad/NetworkData/GW1_Mar8_2021/enp1s0/* .
scp -r jugaad@202.141.30.50:/home/jugaad/NetworkData/GW1_Mar8_2021/enp2s0/* .
  scp -r jugaad@202.141.30.50:/home/jugaad/NetworkData/GW_Mar10_2021/enp1s0/* .
scp -r jugaad@202.141.30.50:/home/jugaad/NetworkData/GW_Mar10_2021/enp2s0/* .
  

  


### Merge the files ###
* For malware tests without the sandbox, only one pcap is presentin the folder.
* mergetoaafolder merges the entire folder wise pcap files into a single folder



* run.sh in pcap analysis - Working case now ...
- python3 mergetoaafolder.py /scratch/sareena/MasterData/Raw/Network/networkrawdata/ /scratch/sareena/MasterData/Raw/Network/bro_input/
- python generaltest.py /scratch/sareena/MasterData/Raw/Network/bro_input/ ./Scripts/ /scratch/sareena/MasterData/Raw/Network/broOutput/ /scratch/sareena/MasterData/Raw/Network/bro_done/

* Below were done to process at the gateway and the server together.
- For the 4.1 processing
	python mergetoaafolder.py /scratch/sareena/MasterData/Raw/Network/enp2s0/ /scratch/sareena/MasterData/Raw/Network/enp2s0_merged 
  	python generaltest.py /scratch/sareena/MasterData/Raw/Network/enp2s0_merged/ ./Scripts/ /scratch/sareena/MasterData/Raw/Network/bro_output/ /scratch/sareena/MasterData/Raw/Network/bro_done/


-For the 2.27 processing
 . python3 mergetoaafolder.py  /media/MalwareDisk/MasterRawData/Network/GW1_Mar8_2021/enp1s0/ ./bro_input/
  This as done to avaoid writing temp files to the malware externalharddisk
 . python generaltest.py ./bro_input ./Scripts  ./bro_output ./bro_done

- mv bro_output later to the harddisk
- mv bro_output/* /media/MalwareDisk/MasterRawData/Network/bro_output/

###Bro Scripts###

* DNS Requests
* Periodicity

## DNS Request

* The scripts are present in the dnsscripts directory
* This code reads the packet capture and generates the logs for the DNS Failure Summary in the dnslogs directory
* The log generated has the following parameters in dnsSummary.log
	- Total no of Dns Req
	- Total no of Dns Failures
	- DNS Failure Types Detected
	- Frequency Of DNS Failed Requests
	- Total no of NXDomain Failures
	- Total no of Server Failures
	- Total no of Refused Requests
* The modified code for changed timespan of 1 min for analysing the frequency is pesent in the dns1minscripts directory

## Periodicity

* The scripts are present in the heartbeatscripts directory
* This code reads the packet capture and generates the logs for the periodicity in the heartbeatlogs directory
* The following logs are generated
	- Heartbeat.log has the following parameters
		- Total no of packets sent per connection (Src IP, Src Port, Dst IP, Dst Port)
		- Periodicity of packets sent per connection 
	- Heartbeat2.log has the following parameters
		- Total no of http requests per Dst URL
		- Periodicity of http requests sent per Dst URl
		- Dst URL
	- HeartbeatIP.log has the following parameters
		- Total no of requests sent per connection (Src IP, Src Port, Dst IP, Dst Port)
		- Periodicity of requests sent in terms of second order difference of time intervals between each request per connection 
	- HeartbeatURL.log has the following parameters
		- Total no of requests sent per Dst URL
		- Periodicity of requests sent in terms of second order difference of time intervals between each request per connection 
	- Out_log_5.log has the following parameters
		- Total no of packets sent per HTTP request per Dst URL
		- Periodicity of packets sent HTTP request per Dst URL

## File Formats Required

* The pcap files are read and related logs are generated using bro.

## Steps to select the dataset 

* 14 datasets are available for each malware.
* One dataset is selected from the 14 datasets to be used.
	- The dataset selected should have 
		- considerable number of packets from/to the infected IP
		- considerable number of connections to the outside IPs
		- considerable file size
		- similar behaviour of the infected IPs in most of the other datasets

## Steps to Use the code

* Create a directory and store all the datasets to be analysed
* Create a directory and store all the scripts to be run on a given dataset
* Create an empty directory to store all the logs generated
* Run the python code generaltest.py with the paths to all the above directories in command line arguments as
>	 python generaltest.py ./DatasetsDirectory ./BroScriptsDirectory ./LogsDirectory
* The python code will read each dataset in the DatasetsDirectory and for each dataset it will run each bro scipt in the BroScriptsDirectory and will story the logs related to each dataset in a directory inside th LogsDirectory under the name of the dataset.