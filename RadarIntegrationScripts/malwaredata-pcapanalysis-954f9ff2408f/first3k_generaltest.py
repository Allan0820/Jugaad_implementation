import os
import subprocess
import sys

data='./Datasets'
broscripts='./Scripts'
genlogs="./logs"

#arguments=sys.argv[1:]
# data=sys.argv[1]
# broscripts=sys.argv[2]
# genlogs=sys.argv[3]
# done_path=sys.argv[4]

data = "../MasterData/Raw/Network_raw_First3K/bro_input/"
broscripts = "./Scripts/"
genlogs = "../MasterData/Raw/Network_raw_First3K/broOutput/"
done_path = "../MasterData/Raw/Network_raw_First3K/bro_done/"

datasets=os.listdir(data)
# scripts=os.listdir(broscripts)

nofdata=len(datasets)
i=1


#subprocess.call(["ls","-l"])

for dataset in datasets :
	name=dataset
	print ()
	print (i, ". ", name )
	argusname = name.split('.')[0].split('_')[1]
	name=name + "_logs"
	path=genlogs+"/"+name
	if (os.path.exists(path)):
		print ("Already done")
		subprocess.call(["mv", data + "/" + dataset, done_path + "/"])
		continue
	try:
		os.mkdir(path)
	except:
		print ("Folder already exists!!")

	path=path+"/"
	subprocess.call(["argus", "-F", "argus.conf", "-r", data + "/" + name, "-w", argusname + ".biargus"])
	print ("argus", "-F", "argus.conf", "-r", data + "/" + name, "-w", argusname + ".biargus")
	print ("ra", "-r", argusname + ".biargus", "-n", "-Z", "b", "-F", "ra.conf", ">", argusname + ".binetflow")

	os.system ("ra -r " + argusname + "-n -Z b -F ra.conf > " + argusname + ".binetflow")

	scripts = ["main.bro", "IPBased2.bro"]
	for script in scripts:
		print (script)
		subprocess.call(["bro","-r",data+"/"+dataset,broscripts+"/"+script])

	logs=os.listdir('.')
	for log in logs:
		temp=log.split('.')
		if len(temp)>1 and temp[1]=="log":
			subprocess.call(["mv","./"+log, path])

	subprocess.call(["mv", argusname +".binetflow" , path])
	subprocess.call(["mv",data+"/"+dataset,done_path+"/"])
	print ("Finished set " )
	print ("Completed " + str(i) + " datasets out of " + str(nofdata))
	print ("######################################")
	i=i+1
