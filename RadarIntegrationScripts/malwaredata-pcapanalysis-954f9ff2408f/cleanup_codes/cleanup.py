import os
import subprocess
import sys

all_datasets_folder=sys.argv[1]###All the datasets folder
cleanup_folder=sys.argv[2]###To store the selected dataset


all_datasets=os.listdir(all_datasets_folder)
datasets_selected_paths=[]

less_than_5_data=open("less_than_5_data.txt","w")
# Ankit to  be tested
empty_frame_files=open("empty_frame_files.txt","w")
datasets_selected_list=open("datasets_selected_list.txt","w")
standalone_sample_list=open("Standalone_sample_list.txt","w")
i=0

for dataset_folder in all_datasets:
    datasets=os.listdir(all_datasets_folder+"/"+dataset_folder)
    list_contains_ips=[]
    no_of_contains_ips=[]
    list_contains_ext_ips=[]

    for dataset in datasets:
        path=all_datasets_folder + "/" + dataset_folder + "/" + dataset
        cmdline="tshark -r " + path + " -qz io,stat,0,ip.addr==192.168.2.11,\"ip.src==192.168.2.11&&ip.dst!=192.168.0.0/16\" > output.txt"
#	print cmdline
        os.system(cmdline)
        inter_file_output=open("output.txt","r")
        ouput_lines=inter_file_output.readlines()
        inter_file_output.close()
        no_of_lines=len(ouput_lines)
        data=ouput_lines[no_of_lines-2].split("|")
		
		# Ankit Some  files empty
        print(data[2])
        print(len(data[2]))
#        print(data[4])
        if(data[2]=='  '):
            empty_frame_files.write(all_datasets_folder + "/" + dataset_folder + "/" + dataset + "\n")
            continue
				
        no_of_infected=int(data[2])
        no_of_out_comm=int(data[4])

        if(no_of_infected!=0):
            list_contains_ips.append(path)
            no_of_contains_ips.append(no_of_infected)

        if(no_of_out_comm!=0):
            list_contains_ext_ips.append(path)
        
        if(len(list_contains_ext_ips)<5):
            less_than_5_data.write(all_datasets_folder + "/" + dataset_folder + str(len(list_contains_ext_ips)) +"\n")
        
        if(len(list_contains_ext_ips)!=0):
            remove_ping="tshark -r" +list_contains_ips[no_of_contains_ips.index(max(no_of_contains_ips))] +" -w " + list_contains_ips[no_of_contains_ips.index(max(no_of_contains_ips))] + " \"!(icmp && data.data contains \"Check profiler\")\""
            datasets_selected_list.write( list_contains_ips[no_of_contains_ips.index(max(no_of_contains_ips))] + "\n")
            datasets_selected_paths.append( list_contains_ips[no_of_contains_ips.index(max(no_of_contains_ips))] + "\n")
		
		# Ankit pls change to mv accordingly
        mv_cmdline="cp " + list_contains_ips[no_of_contains_ips.index(max(no_of_contains_ips))] + " " + "./" + cleanup_folder + "/"
        os.system(mv_cmdline)
    else:
        standalone_sample_list.write(all_datasets_folder + "/" + dataset_folder + "\n")
        i = i + 1
    print ("Finished ",str(i)," out of ",str(len(all_datasets)))
    print ("#########################################")

less_than_5_data.close()
datasets_selected_list.close()
empty_frame_files.close()

