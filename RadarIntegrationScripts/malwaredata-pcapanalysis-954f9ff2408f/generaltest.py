import os
import subprocess
import sys
import os.path

def merge_pcap():

	print("Merging the pcap files")

	all_datasets_folder = "allan_outputs/network_raw_data/"
	merged_folder = "allan_outputs/bro_input/"
	checkingfolder = "allan_outputs/bro_done/"

	all_datasets = os.listdir(all_datasets_folder)
	print(all_datasets)
	datasets_selected_paths = []

	for dataset_folder in all_datasets:
		datasets = os.listdir(all_datasets_folder + "/" + dataset_folder)
		print("inside the dataset function")
		list_contains_ips = []
		no_of_contains_ips = []
		list_contains_ext_ips = []
		
		for dataset in datasets:
			print (dataset)
			# prevDonePath = checkingfolder + "/" + dataset
			# if (os.path.isfile(prevDonePath)):
			#     print ("Previosly processed")
			#     continue
			path1 = all_datasets_folder + "/" + dataset_folder + "/" + dataset
			os.system("cp " + path1 + " " + merged_folder)
	print("Merged files in ", merged_folder )




data='./Datasets'
broscripts='./Scripts'
genlogs="./logs"

merge_pcap()

data = "allan_outputs/bro_input/"
broscripts = "Bro_Inbuild_Scripts/"
genlogs = "allan_outputs/bro_output/"
done_path = "allan_outputs/bro_done/"

datasets=os.listdir(data)
scripts=os.listdir(broscripts)
nofdata=len(datasets)

i=1
subprocess.call(["ls","-l"])

for dataset in datasets :
	name=dataset
	print ()
	print (i, ". ", name )
# 	argusname = name.split('.')[0].split('_')[1]
# 	print('Argus name ',argusname)
# 	name=name + "_logs"
	path=genlogs+"/"+name
# 	# if (os.path.exists(path)):
# 	# 	print ("Already done")
# 	# 	subprocess.call(["mv", data + "/" + dataset, done_path + "/"])
# 	# 	continue
# 	try:
# 		os.mkdir(path)
# 	except:
# 		print("Folder already exists!!")

# 	path=path+"/"
# 	print("Everything is fine till here")
# 	# try:
# 	# 	value=subprocess.call(["argus", "-F", "argus.conf", "-r", data + "/" + name, "-w", argusname + ".biargus"])
# 	# except:

# 	# 	print("Subprocess is throwing an error")



# 	# os.system("argus -F argus.conf -r "+data+ "/" +name+" -w "+ argusname + ".biargus")
# 	print ("argus", "-F", "argus.conf", "-r", data + "/" + name, "-w", argusname + ".biargus")
# 	print ("ra", "-r", argusname + ".biargus", "-n", "-Z", "b", "-F", "ra.conf", ">", argusname + ".binetflow")

# 	os.system ("ra -r " + argusname + "-n -Z b -F ra.conf > " + argusname + ".binetflow")

	# scripts = ["main.bro", "IPBased2.bro"]

	scripts = ["conn.bro"]
	for script in scripts:
		print (script)
		subprocess.call(["zeek","-r",data+"/"+dataset,broscripts+"/"+script])

	logs=os.listdir('.')
	for log in logs:
		temp=log.split('.')
		if len(temp)>1 and temp[1]=="log":
			subprocess.call(["mv","./"+log, path])

	# subprocess.call(["mv", argusname +".binetflow" , path])
	subprocess.call(["mv",data+"/"+dataset,done_path+"/"])
	print ("Finished set " )
	print ("Completed " + str(i) + " datsasets out of " + str(nofdata))
	print ("######################################")
	i=i+1


